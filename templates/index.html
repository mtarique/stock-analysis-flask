<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
	<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
		<div class="container">
			<a class="navbar-brand" href="#">Navbar</a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse" id="navbarNav">
				<ul class="navbar-nav">
					<!-- <li class="nav-item active">
						<a class="nav-link" href="#">Home</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Features</a>
					</li>
					<li class="nav-item">
						<a class="nav-link" href="#">Pricing</a>
					</li>
					<li class="nav-item">
						<a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
					</li> -->
				</ul>
			</div>
		</div>
	</nav>


	<div class="container" style="margin-top: 80px;">



		<h1>Stock Analysis</h1>


		<form id="stockForm" methodsss="post" class="row gy-2 gx-3 align-items-center mb-3">
			<div class="col-md-6">
			  <label for="symbol" class="form-label">Stock Symbol</label>
			  <input type="text" name="symbol" class="form-control" id="symbol" placeholder="e.g. TCS.NS, SUZLON.NS">
			</div>
			<div class="col-md-3">
			  <label for="start_date" class="form-label">Start Date</label>
			  <input type="date" name="start_date" class="form-control" id="start_date">
			</div>
			<div class="col-md-3">
				<label for="end_date" class="form-label">End Date</label>
				<input type="date" name="end_date" class="form-control" id="end_date">
			</div>
			<div class="col-md-2 pb-0">
				<button type="submit" class="btn btn-primary">Submit</button>
			</div>
		</form>

		<!-- Error message -->
		<div id="error"></div>
		

		<!-- The chart will be embedded here -->
		<div id="chart"></div>
	  
		<!-- Stock data table -->
		<div id="stockHistoricalData"></div>
		<!-- <h3>Historical Data</h3>
		<table id="stockData" class="table table-sm table-bordered table-hover small">
		  <thead class="table-light">
			<tr>
			  <th>Date</th>
			  <th>Open</th>
			  <th>High</th>
			  <th>Low</th>
			  <th>Close</th>
			  <th>Volume</th>
			</tr>
		  </thead>
		  <tbody></tbody>
		</table> -->

		<!-- 
		{% if error %}
			<p style="color: red;">{{ error }}</p>
		{% endif %}
		{% if chart_html %}
			<div>{{ chart_html|safe }}</div>
		{% endif %}

		-->


		<!-- Display the historical data as a table -->
		<!--
		{% if stock_data_table %}
			<h2>Historical Data</h2>
			<table border="1">
				<thead>
					<tr>
						<th>Date</th>
						<th>Open</th>
						<th>High</th>
						<th>Low</th>
						<th>Close</th>
						<th>Volume</th>
					</tr>
				</thead>
				<tbody>
					{% for row in stock_data_table %}
						<tr>
							<td>{{ row['Date'] }}</td>
							<td>{{ row['Open'] }}</td>
							<td>{{ row['High'] }}</td>
							<td>{{ row['Low'] }}</td>
							<td>{{ row['Close'] }}</td>
							<td>{{ row['Volume'] }}</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		{% endif %}
		-->

	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

	<script>
		// When the form is submitted, prevent the default form submission
		$('#stockForm').submit(function(event) {
			event.preventDefault();  // Prevent the default form submission
		
			var symbol = $('#symbol').val();
			var startDate = $('#start_date').val();
			var endDate = $('#end_date').val();
	
			// Make an AJAX request to the '/analyze' route
			$.ajax({
				url: '/analyze',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					'symbol': symbol,
					'start_date': startDate,
					'end_date': endDate
				}),
				success: function(response) {
					if (response.error) {

						$errorElem = `
							<div class="alert alert-danger alert-dismissible fade show" role="alert">
								<strong>Oops! </strong>
								${response.error}
								<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
							</div>
						`; 

						$('#error').html($errorElem);

						$('#chart').html('');  // Clear the chart
						$('#stockData tbody').empty();  // Clear the stock data table
					} else {
						$('#error').text('');  // Clear any previous error message
						$('#chart').html(response.chart_html);  // Add the chart HTML
						$('#stockData tbody').empty();  // Clear previous data
			
						// Populate the stock data table
						var stockData = response.stock_data_table;

						if(stockData) {

							let $historicalTable = `
								<h3>Historical Data</h3>
								<table id="stockData" class="table table-sm table-bordered table-hover small">
									<thead class="table-light">
										<tr>
											<th>Date</th>
											<th>Open</th>
											<th>High</th>
											<th>Low</th>
											<th>Close</th>
											<th>Volume</th>
										</tr>
									</thead>
								<tbody>
							`; 

							stockData.forEach(function(row) {

								$historicalTable += `
									<tr>
										<td> ${row.Date} </td>
										<td> ${row.Open} </td>
										<td> ${row.High} </td>
										<td> ${row.Low} </td>
										<td> ${row.Close} </td>
										<td> ${row.Volume} </td>
									</tr>
								`; 
							});

							$historicalTable += `</tbody></table>`; 

							$('#stockHistoricalData').html($historicalTable)

						}
					}
				},
				error: function(xhr, status, error) {
				console.error(error);
				$('#error').text("An error occurred. Please try again.");
				}
			});
		});
	</script>
</body>
</html>
