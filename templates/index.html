<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>
	<div class="container mt-5" styles="margin-top: 80px;">
		<h1>Stock Analysis</h1>
		<form id="stockForm" methodsss="post" class="row gy-2 gx-3 align-items-center mb-3">
			<div class="col-md-6">
			  <label for="symbol" class="form-label">Stock Symbol</label>
			  <input type="text" name="symbol" class="form-control" id="symbol" placeholder="e.g. TCS.NS, SUZLON.NS">
			</div>
			<div class="col-md-3">
			  <label for="start_date" class="form-label">Start Date</label>
			  <input type="date" name="start_date" class="form-control" id="start_date">
			</div>
			<div class="col-md-3">
				<label for="end_date" class="form-label">End Date</label>
				<input type="date" name="end_date" class="form-control" id="end_date">
			</div>
			<div class="col-md-2 pb-0">
				<button type="submit" class="btn btn-primary">Submit</button>
			</div>
		</form>

		<!-- Error message -->
		<div id="error"></div>

		<!-- Stock Info -->
		<div id="stockInfo"></div>

		<!-- The chart will be embedded here -->
		<div id="chart"></div>
	  
		<!-- Stock data table -->
		<div id="stockHistoricalData"></div>
	</div>

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

	<script>
		// When the form is submitted, prevent the default form submission
		$('#stockForm').submit(function(event) {
			event.preventDefault();  // Prevent the default form submission
		
			var symbol = $('#symbol').val();
			var startDate = $('#start_date').val();
			var endDate = $('#end_date').val();
	
			// Make an AJAX request to the '/analyze' route
			$.ajax({
				url: '/analyze',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					'symbol': symbol,
					'start_date': startDate,
					'end_date': endDate
				}),
				success: function(response) {
					if (response.error) {

						let $errorElem = `
							<div class="alert alert-danger alert-dismissible fade show" role="alert">
								<strong>Oops! </strong>
								${response.error}
								<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
							</div>
						`; 

						$('#error').html($errorElem);

						$('#chart').html('');  // Clear the chart
						$('#stockData tbody').empty();  // Clear the stock data table
					} else {
						console.log(response)
						$('#error').text('');  // Clear any previous error message
						$('#stockInfo').text(''); 
						if(response.stock_info) {
							let stockInfo = response.stock_info;
							let currentPrice = parseFloat(stockInfo.currentPrice); 

							let recommendationColor = response.prediction == 'Buy' ? "text-bg-success" : "text-bg-danger"; 
							
							let $infoElem = `
								<!-- <button class="btn btn-danger">${response.prediction}</button>-->
								<h3>${stockInfo.longName} (${stockInfo.symbol})</h3>
								<hr>
								<div class="d-flex justify-content-between -align-items-middle">
								<h1>${getCurrencySymbol(stockInfo.currency)}${currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</h1>
								<h1><span class="badge text-dark-  ${recommendationColor}">${response.prediction}</span></h1>
								</div>
								
							`; 

							$('#stockInfo').html($infoElem); 
						}

						
						$('#chart').html(response.chart_html);  // Add the chart HTML
						$('#stockData tbody').empty();  // Clear previous data
			
						// Populate the stock data table
						var stockData = response.stock_data_table;

						if(stockData) {

							let $historicalTable = `
								<h3>Historical Data</h3>
								<table id="stockData" class="table table-sm table-bordered table-hover small">
									<thead class="table-light">
										<tr>
											<th>Date</th>
											<th>Open</th>
											<th>High</th>
											<th>Low</th>
											<th>Close</th>
											<th>Volume</th>
										</tr>
									</thead>
								<tbody>
							`; 

							stockData.forEach(function(row) {

								$historicalTable += `
									<tr>
										<td> ${row.Date} </td>
										<td> ${row.Open} </td>
										<td> ${row.High} </td>
										<td> ${row.Low} </td>
										<td> ${row.Close} </td>
										<td> ${row.Volume} </td>
									</tr>
								`; 
							});

							$historicalTable += `</tbody></table>`; 

							// HTML Table
							$('#stockHistoricalData').html($historicalTable)
						}
					}
				},
				error: function(xhr, status, error) {
					console.error(error);
					let $errorElem = `
						<div class="alert alert-danger alert-dismissible fade show" role="alert">
							<strong>Oops! </strong>
							${xhr.status}
							<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
						</div>
					`; 

					$('#error').html($errorElem);
				}
			});

			function getCurrencySymbol(currencyCode) {
				return (0).toLocaleString('en', {
					style: 'currency',
					currency: currencyCode,
					minimumFractionDigits: 0,
					maximumFractionDigits: 0
				}).replace(/\d/g, '').trim();
			}

		});
	</script>
</body>
</html>
